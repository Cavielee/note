# 分布式选举算法

在分布式中，为了提高集群执行效率问题，进而演变出主从模式。

Leader 节点（也叫作 Master 节点）用于执行事务型操作。

Follower 节点（也叫作 Slave 节点）用于执行读操作。

通过将读写操作分步到不同节点去执行，从而提高整体的执行效率。

由于 Leader 节点存在单节点问题，当 Leader 节点不可用时，需要一种机制去实现节点之间自动选取出新的 Leader 节点，从而实现 Leader 节点高可用。这种机制也称作——选举算法。

# Raft 算法

http://thesecretlivesofdata.com/raft/

原理：

1. 集群中的每个节点都会随机生成一个 timeout 时间（150ms~300ms）。
2. 当 timeout 时间结束时，会发起选举投票，节点会选择自己作为 Leader 节点。
3. 其他节点收到该节点发送的选举投票后，会将收到的票据内容作为自己的票据内容进行投票。
4. 如果某个节点获得半数以上的投票，则该节点为新的 Leader 节点。



上述过程中存在两个问题：

1. 周期（Term）问题。节点每一次发起投票都会更新当前投票的周期，由于网络原因可能会导致节点之间的周期不一致问题，出现不在同一轮周期的投票。
   1. 当节点收到其他节点的选举投票，票据所在周期比自身节点周期小，则会判断该票据位无用票据并丢弃。
   2. 当节点收到其他节点的选举投票，票据所在周期比自身周期大，则会将自身周期改成票据所在周期，并将该票据内容作为自己的票据内容进行投票。
2. 票数相同问题。如果集群节点是偶数，且刚好有两个节点随机的 timeout 时间相同，则会同时发起以自身为 leader 的投票，最终导致两个节点票数相同，此时相同票数的节点再一次重新随机一个 timeout 时间，并在 timeout 结束时再发起一轮投票，直到其中一个节点获得半数以上的票成为 leader 为止。因此一般建议集群节点设置为奇数，防止上述的脑裂问题。