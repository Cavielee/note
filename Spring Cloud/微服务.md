# 什么是微服务架构

　　微服务是系统架构上的一种设计风格，它的主旨是将一个原本独立的系统拆分成多个小型服务，这些小型服务都在各自独立的进程中运行，服务之间通过基于 HTTP 的 RESTful API 进行通信协作。被拆分成的每一个小型服务都围绕着系统中的某一项或一些耦合度较高的业务功能进行构建，并且每个服务都维护着自身的数据存储、业务开发、自动化测试案例以及独立部署机制。由于有了轻量级的通信协作基础，所以这些微服务可以使用不同的语言来编写。



# 为什么要微服务架构

　　传统的企业系统架构中，我们把所有的业务逻辑都放在一个应用中，这样子前期的开发、测试、部署比较容易。但是随着规模的发展，业务需求不断增加，模块随之不断增加，导致单体应用变得越来越臃肿。由于单体系统部署在一个线程内，我们如果需要改一个小小的功能，重新部署时都会影响其他不相关功能暂时不可用；并且，单体应用中每个功能模块的使用场景、并发量、消耗的资源类型都各不相同，对于资源的利用又相互影响，这样使得我们对各个业务模块的系统容量很难给出较为准确的评估。最终导致后期维护成本变得越来越大，且难以控制。



　　微服务架构将系统中的不同功能模块拆分成多个不同的服务，这些服务都能够独立部署和扩展。由于每个服务器都运行在自己的进程内，在部署上有稳固的边界，这样每个服务的更新都不会影响其他服务的运行。同事，可以更准确地为每个服务评估性能容量，通过配合服务间的协作流程也可以更容易地发现系统的瓶颈位置，以及给出较为准确的系统级性能容量评估。



# 实施难点

* 运维：

由于微服务架构导致单体应用被拆分成多个子服务节点，运维需要维护的进程数量/服务器数量会大大增加，需要运维人员使用自动化技术去维护这些子服务节点。

* 接口的一致性：

虽然拆分了服务，但业务逻辑上的依赖并不会消除，只是从单体应用的代码依赖变成服务之间的通信依赖。一旦我们对原来的接口进行修改，需要告知交互方作出改变。因此需要完善接口和版本管理，或是严格地遵循开闭原则（抽出接口，对于扩展只需要实现接口扩展，对外接口不作变化，只变更实现提供类）

* 分布式的复杂性：

由于拆分后的各个微服务都是独立部署并运行在各自的进程内，它们只能通过通信来进行协作，因此需要考虑网络延迟、分布式事务、异步消息等因素。



# 微服务的特性

* 服务组件化：

微服务架构中将单体应用拆分成多个服务，每个服务各自占一个进程，因此每个服务都可以独立开发、部署，避免一个服务的修改引起整个系统的重新部署。

* 按业务组织团队：

由于划分了多个服务，每个服务都可能涉及到前端、后端、运维、DB等操作，因此应当按照业务来分配人员（可能需要宽栈/全栈的成员），而不是按照传统的分为DBA团队、运维团队、前端团队、后端团队、策划团队。

* 服务调用：

在单体应用中，组件之间的交互是通过函数直接调用。但在微服务中，服务不在同一个进程，如果使用 RPC 方式的调用，会导致微服务之间产生繁琐的通信，因此需要更粗粒度的通信协议：

1. 第一种，使用 HTTP 的 RESTful API 或轻量级的消息发送协议，实现信息传递与服务调用的触发。
2. 第二种，通过在轻量级消息总线上传递消息，类似 RabbitMQ 等一些提供可靠异步交换的中间件。

> 在极度强调性能的情况下，有些团队会使用二进制的消息发送协议，例如 protobuf。

* 去中心化治理

单体应用中，要求整个应用采用统一的技术，但是使用微服务架构，可以根据具体需求采取不同的技术架构去实现每一个服务，只需按照指定的接口相互交互即可。

* 去中心化管理数据

采用微服务架构时，可以根据服务模块将原本数据库的表拆分，并放在不同的数据库实例中（一些特殊结构或业务特性的数据可以存到例如 Redis 这些数据库实例中）。但缺点是，要解决数据在不同数据库实例的一致性问题，采取分布式事务，其实现难度非常大，一般采取数据最终一致性（若发现错误，通过补偿机制进行处理，是的错误数据最终的一致性）。

* 基础设施自动化

由于采用微服务架构，数据库和应用程序被拆分，导致数量倍增，使得运维人员关注的内容和操作的任务也成倍增长。因此需要：

1. 自动化测试：每次部署钱的强心剂，尽可能地获得对正在运行的软件的信心。
2. 自动化部署：解放繁琐枯燥的重复操作以及对多环境的配置管理。

* 容错设计

在单体应用中，如果某个组件故障将会导致整个应用故障。而在微服务架构中，其中一个应用故障，不会影响整体不能运作，只是会导致关联的服务出现故障。因此微服务架构中应快速检测故障源和自动恢复服务，一般需要在每个服务中实现监控和日志记录的组件，比如服务状态、断路器状态、吞吐量、网络延迟等关键数据的仪表盘。



# 微服务技术选择

* 服务治理：阿里巴巴开源的 `Dubbo` 和当当网在其基础上扩展的 `DubboX`、`Netflix` 的 `Eureka`、`HashiCorp` 的 `Consul` 等。
* 分布式配置管理：百度的 `Disconf` 、`Netflix` 的 `Archaius`、360 的 `QConf`、`Spring cloud` 的 `Config`、淘宝的 `Diamond`等。
* 批量任务：当当网的 `Elastic-Job`、`LinkedIn` 的 `Azkaban`、`Spring cloud` 的 `Task`等。
* 服务跟踪：京东的 `Hydra`、`Spring cloud` 的 `Sleuth` 、`Twitter` 的 `Zipkin` 等。